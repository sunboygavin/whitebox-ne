# 白盒网元 (WhiteBox NE) 完整操作手册

> 基于 FRRouting (FRR) 的纯命令行白盒网元解决方案
> 项目地址: https://github.com/sunboygavin/whitebox-ne
> 文档版本: v1.0
> 更新日期: 2026-02-10

---

## 目录

1. [项目概述](#1-项目概述)
2. [系统要求](#2-系统要求)
3. [安装部署](#3-安装部署)
4. [启动与停止](#4-启动与停止)
5. [远程访问](#5-远程访问)
6. [配置管理](#6-配置管理)
7. [协议配置](#7-协议配置)
8. [监控与排障](#8-监控与排障)
9. [源码定制](#9-源码定制)
10. [最佳实践](#10-最佳实践)

---

## 1. 项目概述

### 1.1 什么是白盒网元？

白盒网元是基于开放软件协议栈（FRRouting）的网络设备解决方案，提供：
- 标准路由协议支持（BGP, OSPF, VRRP, SRv6, Flowspec）
- 华为风格命令行界面
- SNMP 管理接口
- 可源码级定制

### 1.2 核心组件

| 组件 | 功能 | 状态 |
|------|------|------|
| **Zebra** | 核心路由管理器 | ✅ 运行中 |
| **BGP Daemon (bgpd)** | BGP 协议（SRv6, Flowspec） | ✅ 运行中 |
| **OSPF Daemon (ospfd)** | OSPF 协议 | ✅ 运行中 |
| **VRRP Daemon (vrrpd)** | VRRP 协议 | ✅ 运行中 |
| **Net-SNMP (snmpd)** | SNMP 代理（AgentX） | ✅ 运行中 |
| **VTYSH** | 命令行界面 | ✅ 可用 |

### 1.3 项目文件结构

```
whitebox-ne/
├── README.md                  # 项目文档
├── install_script.sh          # 快速安装脚本
├── build_from_source.sh        # 源码构建脚本
├── frr.conf                  # FRR 配置模板
├── net_snmp.conf             # SNMP 配置模板
├── netconf_guide.md           # Netconf 集成指南
├── src/
│   ├── frr_core/            # 修改后的 FRR 源码
│   │   ├── lib/command.c     # 华为风格 CLI
│   │   ├── zebra/srv6.c     # SRv6 逻辑
│   │   └── bgpd/bgp_flowspec.c  # Flowspec 逻辑
│   ├── frr_patch/           # 补丁文件
│   └── snmp_subagent/      # 自定义 SNMP 子代理
```

---

## 2. 系统要求

### 2.1 硬件要求

- CPU: 至少 2 vCPU
- 内存: 至少 4GB RAM
- 磁盘: 至少 20GB
- 网络: 至少 2 个网络接口

### 2.2 软件要求

- 操作系统: **Ubuntu 22.04 LTS** (推荐)
- Linux 内核: 5.4+ (支持 SRv6)
- 用户权限: root 或 sudo 访问权限

### 2.3 依赖组件

```bash
# 必需组件
frr          # FRRouting 主程序
frr-snmp     # FRR SNMP 扩展
snmp snmpd   # Net-SNMP 代理
```

---

## 3. 安装部署

### 3.1 克隆项目

```bash
# 克隆 GitHub 仓库
cd /opt  # 或 /usr/local/src
sudo git clone https://github.com/sunboygavin/whitebox-ne.git
cd whitebox-ne
```

### 3.2 快速安装（推荐）

适用于快速部署和测试，使用预编译包：

```bash
# 1. 添加执行权限
sudo chmod +x install_script.sh

# 2. 执行安装脚本
sudo ./install_script.sh
```

**安装脚本执行内容**：
1. 更新系统软件包
2. 安装 FRR、FRR-SNMP、SNMP
3. 启用守护进程：zebra, bgpd, ospfd, vrrpd
4. 配置 AgentX 支持
5. 重启服务

### 3.3 从源码构建（高级开发）

适用于需要源码级定制的场景：

```bash
# 1. 添加执行权限
sudo chmod +x build_from_source.sh

# 2. 执行源码构建脚本
sudo ./build_from_source.sh
```

**源码构建执行内容**：
1. 安装编译依赖
2. 下载 FRR 官方源码 (v8.1)
3. 应用自定义补丁
4. 编译并安装 FRR
5. 编译自定义 SNMP 子代理

### 3.4 应用配置

```bash
# 1. 拷贝配置文件模板
sudo cp frr.conf /etc/frr/frr.conf

# 2. 设置正确的权限
sudo chown frr:frr /etc/frr/frr.conf

# 3. 重启 FRR 服务
sudo systemctl restart frr
```

---

## 4. 启动与停止

### 4.1 服务管理

```bash
# 启动 FRR
sudo systemctl start frr

# 停止 FRR
sudo systemctl stop frr

# 重启 FRR
sudo systemctl restart frr

# 查看状态
sudo systemctl status frr

# 开机自启
sudo systemctl enable frr
```

### 4.2 查看服务状态

```bash
# FRR 主服务
systemctl status frr

# 单个守护进程
systemctl status zebra
systemctl status bgpd
systemctl status ospfd
systemctl status vrrpd

# SNMP 服务
systemctl status snmpd
```

### 4.3 检查运行状态

```bash
# 方法 1: 使用 vtysh
sudo vtysh -c "show version"
sudo vtysh -c "show running-config"

# 方法 2: 查看进程
ps aux | grep frr

# 方法 3: 查看端口
netstat -tlnp | grep -E "179|2601|161"
```

---

## 5. 远程访问

### 5.1 方式一：SSH + vtysh（推荐，最安全）

**适用场景**：日常远程管理

#### 步骤：

```bash
# 从本地电脑连接
ssh root@服务器IP

# 登录后进入 vtysh
sudo vtysh
```

#### 一行命令直接进入：

```bash
ssh root@服务器IP -t "sudo vtysh"
```

### 5.2 方式二：SSH 隧道 + telnet

**适用场景**：模拟传统路由器访问方式

#### 步骤：

```bash
# 1. 在本地创建 SSH 隧道（后台运行）
ssh -L 2601:127.0.0.1:2601 root@服务器IP -N

# 2. 在另一个终端连接
telnet localhost 2601
```

### 5.3 方式三：直接监听所有接口（不推荐，安全性低）

**⚠️ 警告**：此方式会暴露管理端口到公网，仅在内网环境使用

#### 步骤：

1. **修改守护进程配置**：
```bash
sudo vi /etc/frr/daemons
```

修改监听地址：
```bash
# 原配置：
zebra_options="-M snmp -A 127.0.0.1 -s 90000000"

# 修改为：
zebra_options="-M snmp -A 0.0.0.0 -s 90000000"
```

2. **重启 FRR**：
```bash
sudo systemctl restart frr
```

3. **开放防火墙**：
```bash
# UFW 防火墙
sudo ufw allow 2601/tcp  # vtysh 端口
sudo ufw allow 179/tcp   # BGP 端口
sudo ufw allow 89/tcp    # OSPF 端口
```

4. **远程连接**：
```bash
telnet 服务器IP 2601
```

---

## 6. 配置管理

### 6.1 进入配置模式

```bash
# 方法 1: 交互式
sudo vtysh
# 进入后执行
configure terminal

# 方法 2: 单行命令
sudo vtysh -c "configure terminal"
```

### 6.2 常用配置命令

| 功能 | 华为风格 | Cisco 风格 | 说明 |
|------|----------|-------------|------|
| 进入配置模式 | `system-view` | `configure terminal` | |
| 查看运行配置 | `display current-configuration` | `show running-config` | |
| 保存配置 | `save` | `write` | 保存到启动配置 |
| 退出配置模式 | `quit` | `exit` | |

### 6.3 接口配置示例

```bash
# 进入 vtysh
sudo vtysh

# 配置接口
configure terminal
interface eth0
 ip address 192.168.10.1/24
 ipv6 address 2001:db8:a::1/64
 no shutdown
exit

# 保存配置
write
```

### 6.4 配置文件位置

```bash
# FRR 主配置文件
/etc/frr/frr.conf

# 守护进程配置
/etc/frr/daemons

# VTYSH 配置
/etc/frr/vtysh.conf

# SNMP 配置
/etc/snmp/snmpd.conf

# 日志文件
/var/log/frr/frr.log
```

---

## 7. 协议配置

### 7.1 BGP 配置

#### 基本 BGP 配置：

```bash
sudo vtysh
configure terminal

router bgp 65000
 bgp router-id 1.1.1.1
 neighbor 203.0.113.2 remote-as 65001
 !
 address-family ipv4 unicast
  network 192.168.10.0/24
  neighbor 203.0.113.2 activate
 exit-address-family
exit
write
```

#### SRv6 配置：

```bash
configure terminal
router bgp 65000
 neighbor 2001:db8:b::2 remote-as 65001
 !
 address-family ipv6 unicast
  network 2001:db8:1::/64
  neighbor 2001:db8:b::2 activate
 exit-address-family
exit
write
```

#### Flowspec 配置：

```bash
configure terminal
router bgp 65000
 !
 address-family ipv4 flowspec
  neighbor 2001:db8:b::2 activate
 exit-address-family
exit
write
```

#### 查看 BGP 状态：

```bash
# 查看邻居摘要
show ip bgp summary

# 查看路由表
show ip bgp

# 查看指定邻居
show ip bgp neighbors 203.0.113.2

# 华为风格
display bgp peer
```

### 7.2 OSPF 配置

#### 基本 OSPF 配置：

```bash
sudo vtysh
configure terminal

router ospf
 ospf router-id 1.1.1.1
 network 192.168.10.0/24 area 0.0.0.0
exit

# 配置接口 OSPF
interface eth0
 ip ospf area 0.0.0.0
exit

write
```

#### 查看 OSPF 状态：

```bash
# 查看邻居
show ip ospf neighbor

# 查看接口
show ip ospf interface

# 查看路由
show ip ospf route

# 华为风格
display ip ospf peer
```

### 7.3 VRRP 配置

```bash
sudo vtysh
configure terminal

interface eth0
 vrrp 10
  vrrp-description "主网关备份"
  vrrp-primary
  vrrp-priority 100
  vrrp-vip 192.168.10.254/24
exit

write
```

#### 查看 VRRP 状态：

```bash
show vrrp

# 华为风格
display vrrp
```

---

## 8. 监控与排障

### 8.1 日志查看

```bash
# 查看 FRR 日志
sudo tail -f /var/log/frr/frr.log

# 查看系统日志
sudo journalctl -u frr -f

# 查看守护进程日志
sudo journalctl -u zebra -f
sudo journalctl -u bgpd -f
```

### 8.2 性能监控

```bash
# 查看进程资源使用
top -p $(pgrep -f "zebra|bgpd|ospfd")

# 查看内存使用
ps aux | grep frr | awk '{print $2, $4, $6, $11}'

# 查看网络连接
netstat -anp | grep -E "179|2601|89"
```

### 8.3 SNMP 监控

#### 验证 SNMP AgentX：

```bash
# 查看系统信息
snmpwalk -v2c -c public localhost .1.3.6.1.2.1.1.1.0

# 查看 BGP MIB
snmpwalk -v2c -c public localhost .1.3.6.1.2.1.15

# 查看接口 MIB
snmpwalk -v2c -c public localhost .1.3.6.1.2.1.2
```

#### 启动自定义 SNMP 子代理：

```bash
cd /root/.openclaw/workspace/whitebox-ne/src/snmp_subagent
sudo ./custom_subagent &
```

### 8.4 常见问题排查

| 问题 | 可能原因 | 解决方案 |
|------|----------|----------|
| BGP 邻居无法建立 | 防火墙、AS 号错误 | 检查 `show ip bgp summary`，开放端口 179 |
| OSPF 邻居无法建立 | 网络掩码、区域不匹配 | 检查 `show ip ospf neighbor`，验证配置 |
| vtysh 无法进入 | 配置文件权限 | 确保 `/etc/frr/frr.conf` 属于 `frr:frr` |
| SNMP 无法获取数据 | AgentX 未启用 | 检查 `snmpd.conf` 包含 `master agentx` |
| 服务无法启动 | 配置文件语法错误 | 使用 `frr --test` 检查配置 |

### 8.5 调用 Debug 模式

```bash
# 修改 /etc/frr/daemons，添加 debug 选项
# bgpd_options="-M snmp -A 127.0.0.1 --debug bgp"

# 或在 vtysh 中启用
sudo vtysh
configure terminal
debug bgp events
debug bgp zebra

# 查看调试日志
sudo tail -f /var/log/frr/frr.log
```

---

## 9. 源码定制

### 9.1 修改华为风格 CLI

**文件位置**: `src/frr_core/lib/command.c`

#### 添加新命令示例：

```c
// 在 command.c 中添加命令注册
DEFUN (cmd_custom_command,
       custom_command_cmd,
       "custom-command",
       "自定义华为风格命令")
{
  /* 命令处理逻辑 */
  vty_out(vty, "执行自定义命令\n");
  return CMD_SUCCESS;
}

/* 注册命令到命令表 */
static const struct cmd_element custom_command_elem =
  CMD_INSTALL_NODE(CONFIG_NODE, VIEW_NODE, CONFIG_CMD,
                 "custom-command", "自定义命令描述");
```

### 9.2 修改 SRv6 逻辑

**文件位置**: `src/frr_core/zebra/srv6.c`

#### 定制 SID 处理：

```c
/* 修改 SID 安装逻辑 */
int zebra_srv6_sid_install(struct zebra_vrf *zvrf,
                         struct srv6_sid *sid)
{
  /* 添加自定义逻辑 */
  /* 例如：记录 SID 分配、对接硬件等 */

  return 0;
}
```

### 9.3 修改 Flowspec 逻辑

**文件位置**: `src/frr_core/bg/bgp_flowspec.c`

#### 定制 Flowspec 规则处理：

```c
/* 修改规则解析逻辑 */
int bgp_fs_parse_action(struct bgp *bgp,
                      struct bgp_fs_route *fs)
{
  /* 添加自定义动作解析 */
  /* 例如：重定向到控制器 */
  return 0;
}
```

### 9.4 编译并部署

```bash
# 1. 修改源码后，重新构建
cd /root/.openclaw/workspace/whitebox-ne
sudo ./build_from_source.sh

# 2. 重启服务
sudo systemctl restart frr
```

---

## 10. 最佳实践

### 10.1 配置管理

```bash
# 1. 备份配置
sudo cp /etc/frr/frr.conf /etc/frr/frr.conf.backup

# 2. 测试配置
sudo vtysh -c "show running-config" > new_config.conf

# 3. 验证语法
# FRR 没有内置的配置验证工具，建议通过日志检查

# 4. 应用新配置
sudo cp new_config.conf /etc/frr/frr.conf
sudo chown frr:frr /etc/frr/frr.conf
sudo systemctl restart frr
```

### 10.2 安全建议

```bash
# 1. 限制 vtysh 访问（本地监听）
# 确保 /etc/frr/daemons 中使用 -A 127.0.0.1

# 2. 配置防火墙
sudo ufw enable
sudo ufw default deny incoming
sudo ufw allow from 信任的IP to any port 22  # SSH
sudo ufw allow from 信任的IP to any port 179 # BGP
sudo ufw allow from 信任的IP to any port 89  # OSPF

# 3. SNMP 访问控制
# 在 /etc/snmp/snmpd.conf 中限制访问
# view systemonly included .1.3.6.1.2.1.1
# access notConfigGroup "" any noauth exact systemonly none none
```

### 10.3 高可用部署

```bash
# 使用 VRRP 实现网关冗余
# 在两台设备上配置：
interface eth0
 vrrp 10
  vrrp-priority 100  # 主设备 100，备设备 50
  vrrp-vip 192.168.10.254/24
  vrrp-preempt
```

### 10.4 监控集成

```bash
# 配置 SNMP 监控
# 1. 安装监控工具（如 Prometheus + snmp_exporter）
# 2. 配置 SNMP exporter 指向本机
# 3. 设置 Grafana 仪表板
```

---

## 附录

### A. 端口对照表

| 服务 | 端口 | 协议 | 说明 |
|------|-------|------|------|
| vtysh | 2601 | TCP | 命令行接口 |
| BGP | 179 | TCP | BGP 协议 |
| OSPF | 89 | UDP | OSPF 协议 |
| SNMP | 161 | UDP | SNMP 代理 |
| SNMP Trap | 162 | UDP | SNMP 陷阱 |

### B. 配置文件示例

查看完整配置示例：
```bash
cat /root/.openclaw/workspace/whitebox-ne/frr.conf
```

### C. 参考资源

- **FRR 官方文档**: https://docs.frrouting.org/
- **项目 GitHub**: https://github.com/sunboygavin/whitebox-ne
- **Netconf 集成指南**: `/root/.openclaw/workspace/whitebox-ne/netconf_guide.md`
- **测试报告**: `/root/.openclaw/workspace/whitebox-ne/TEST_REPORT.md`

---

## 联系与支持

- 项目维护者: Gavin (sunboygavin)
- GitHub Issues: https://github.com/sunboygavin/whitebox-ne/issues

---

**文档结束**
